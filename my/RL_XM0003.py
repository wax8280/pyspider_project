#!/usr/bin/env python
# -*- encoding: utf-8 -*-
# Created on 2017-01-10 10:45:59
# Project: RL_XM0003


from pyspider.libs.base_handler import *
import re
from copy import deepcopy
import hashlib
import json

DIVIDE = 3
RESULT_PATH = './result/RL_XM0003/result/'

position_list = ["41840", "27594", "41893", "32151", "19517", "31930", "42129", "57150", "17292", "39182", "46370",
                 "43788",
                 "42148", "41951", "42124", "27820", "27577", "27807", "32152", "19518", "32059", "19506", "32148",
                 "19515",
                 "31997", "31851", "31991", "38389", "38401", "42145", "42129", "46245", "46296", "46299", "46298",
                 "33670",
                 "33752", "33758", "33754", "42004", "41947", "36690", "16617", "32462", "32283", "32296", "32298",
                 "32297",
                 "30129", "30221", "30227", "50112", "50113", "50110", "30224", "42463", "42469", "42472", "42471",
                 "24849",
                 "24864", "24867", "24866", "45979", "31150", "57151", "31143", "57152", "57153", "28440", "28451",
                 "57154",
                 "43052", "42909", "43013", "13422", "43038", "43017", "48150", "29367", "40269", "31439", "50108",
                 "26359",
                 "40190", "49128", "17502", "57194", "17527", "57195", "57445", "39070", "46364", "37778", "36327",
                 "14440",
                 "14347", "14424", "49991", "14284", "14429", "14347", "14424", "14264", "23926", "23940", "23888",
                 "23930",
                 "23942", "23933", "16089", "34403", "34419", "34423", "34421", "37149", "37155", "37159", "37157",
                 "15781",
                 "15804", "15773", "49061", "49099", "49119", "37734", "15754", "11554", "57196", "57197", "57198",
                 "57199",
                 "57200", "57201", "57202", "57203", "57204", "57205", "57206", "57207", "57208", "57209", "57210",
                 "57211",
                 "57212", "57213", "57214", "57215", "36792", "57216", "57217", "57218", "57219", "57220", "57221",
                 "57222",
                 "57223", "57224", "50551", "57225", "57226", "57227", "12877", "57228", "57229", "57230", "57231",
                 "31397",
                 "43124", "25738", "41011", "36733", "57232", "57233", "32952", "31633", "57234", "57235", "57236",
                 "57237",
                 "57238", "45628", "57239", "49592", "57240", "57241", "57242", "45565", "57243", "57244", "57245",
                 "36138",
                 "57477", "45359", "14915", "12644", "57246", "57247", "57248", "39443", "39491", "29125", "15218",
                 "15444",
                 "15451", "15446", "57249", "57250", "57251", "57252", "57253", "45572", "12476", "29740", "15414",
                 "57254",
                 "57255", "57256", "57257", "57258", "45709", "39126", "38847", "57259", "46299", "46245", "46301",
                 "39542",
                 "29728", "40147", "41154", "41021", "38974", "38989", "34967", "11449", "11487", "40189", "37347",
                 "36337",
                 "57261", "11495", "11395", "43401", "43447", "11485", "57262", "25470", "57260", "45378", "31633",
                 "45390",
                 "37648", "45761", "40388", "57461", "57462", "57463", "57464", "57465", "57466", "57161", "57162",
                 "50118",
                 "50119", "16715", "27633", "43820", "43949", "43956", "43952", "44465", "44461", "57163", "57164",
                 "57165",
                 "57166", "42493", "57167", "57168", "57169", "57170", "57171", "57172", "57173", "19598", "50117",
                 "14064",
                 "57174", "57175", "38459", "50114", "37975", "46952", "37891", "37964", "46932", "57176", "50115",
                 "57177",
                 "57178", "57179", "57180", "32856", "32845", "32853", "32855", "32854", "21980", "30941", "57181",
                 "19572",
                 "57182", "57183", "16255", "57184", "37868", "30949", "13631", "13647", "13649", "13640", "14311",
                 "13641",
                 "13672", "57185", "57186", "57187", "15709", "13651", "27633", "57188", "13670", "15715", "57301",
                 "57302",
                 "30017", "57303", "57304", "57305", "42495", "35799", "35441", "35786", "35793", "35790", "45004",
                 "45087",
                 "45093", "45091", "38404", "38403", "30566", "30635", "30639", "30637", "14978", "15010", "31022",
                 "31049",
                 "15014", "15012", "24190", "24228", "16495", "16480", "16491", "57189", "57190", "35364", "31052",
                 "21893",
                 "21845", "21888", "21891", "21890", "28979", "29012", "29015", "29014", "28947", "28973", "16452",
                 "16435",
                 "16449", "34114", "34168", "57191", "34124", "40147", "29251", "47406", "27820", "27577", "27807",
                 "24110",
                 "24118", "23980", "23996", "23998", "23997", "41461", "57192", "57193", "45819", "42202", "16183",
                 "21348",
                 "16754", "57155", "25628", "57156", "28333", "57157", "38788", "44393", "29234", "37566", "37563",
                 "43251",
                 "57158", "26256", "26224", "30097", "30149", "26122", "30224", "30223", "57159", "30090", "30111",
                 "46782",
                 "27847", "57160", "53715", "13914", "48768", "40301", "57391", "29227", "25222", "14468", "17223",
                 "40147",
                 "42258", "28691", "57392", "30026", "44532", "57393", "57394", "14978", "57274", "27264", "57275",
                 "41951",
                 "42124", "47667", "57276", "57277", "30873", "20584", "57278", "38142", "26426", "43333", "26052",
                 "57279",
                 "57280", "57281", "57282", "57283", "57284", "57285", "57286", "57287", "57288", "57289", "57290",
                 "57291",
                 "57292", "50269", "57293", "29633", "46038", "26970", "57294", "35824", "57295", "57296", "45891",
                 "34889",
                 "34882", "34928", "57297", "40823", "40866", "40869", "40868", "57298", "57299", "40846", "40794",
                 "57300",
                 "40754", "18006", "17727", "57317", "57318", "17490", "57319", "57320", "11229", "11217", "57321",
                 "34251",
                 "57322", "57323", "22209", "46836", "57324", "57325", "17913", "57326", "57327", "57328", "44404",
                 "57329",
                 "35928", "57330", "57331", "57332", "57333", "18062", "17737", "57334", "57335", "18234", "17648",
                 "57336",
                 "44288", "44257", "25123", "57337", "14906", "57338", "18444", "57339", "57340", "15689", "57341",
                 "57342",
                 "48800", "57343", "31242", "57344", "24577", "24656", "24711", "24702", "57345", "24584", "57346",
                 "31195",
                 "36863", "29465", "25598", "48384", "48524", "18531", "57347", "57348", "24358", "14110", "24681",
                 "57349",
                 "57350", "57351", "57352", "57353", "57354", "57355", "23055", "14591", "14539", "14584", "14590",
                 "14587",
                 "57306", "21941", "28855", "14519", "28923", "28936", "28938", "28937", "43788", "13753", "40730",
                 "40658",
                 "40723", "40727", "40725", "24296", "46145", "46152", "28107", "37298", "57307", "27989", "28687",
                 "57308",
                 "13768", "16854", "14790", "14826", "14781", "57309", "57310", "57311", "57312", "40615", "57313",
                 "12269",
                 "13281", "57314", "44760", "18926", "32717", "16975", "18609", "23014", "15580", "57264", "18906",
                 "18915",
                 "18919", "18917", "28781", "28788", "31127", "57265", "57266", "48582", "57267", "23148", "57268",
                 "49030",
                 "48997", "49024", "48986", "49022", "48657", "18309", "36696", "57402", "57403", "57404", "48676",
                 "15502",
                 "21511", "34732", "34643", "15659", "34721", "34521", "34734", "57315", "34543", "15167", "34589",
                 "47364",
                 "21687", "47269", "21625", "57316", "13509", "40189", "25080", "15596", "29598", "40980", "15917",
                 "29464",
                 "31593", "24749", "13322", "17215", "28902", "17196", "37072", "29611", "45533", "15474", "15028",
                 "27926",
                 "17831", "22523", "31319", "31249", "50102", "14848", "13508", "57269", "14915", "57270", "47582",
                 "47518",
                 "57271", "25811", "32650", "32652", "13066", "57272", "13068", "57273", "13074", "16213", "29391",
                 "18273",
                 "15064", "27240", "57410", "16211", "31733", "19735", "50132", "50133", "35130", "57411", "35119",
                 "57412",
                 "16715", "16717", "27062", "28656", "57407", "31585", "57408", "57409", "45884", "42744", "19735",
                 "28747",
                 "16946", "30412", "18131", "28864", "30552", "36099", "36098", "18228", "45208", "16934", "28331",
                 "16928",
                 "30510", "19017", "29644", "33930", "48072", "57405", "57406", "23589", "57384", "23641", "57385",
                 "37328",
                 "57263", "57387", "57424", "27927", "32244", "57425", "57426", "37079", "37032", "17441", "17446",
                 "57427",
                 "57428", "57429", "57430", "57431", "57432", "57433", "57434", "57435", "57436", "57437", "57438",
                 "57439",
                 "23814", "32156", "29679", "38489", "18634", "43313", "46921", "47921", "28838", "42365", "43509",
                 "43554",
                 "44188", "19330", "57416", "25825", "57417", "43635", "28334", "36416", "23526", "57418", "45119",
                 "57419",
                 "57420", "13587", "44204", "46732", "46754", "57372", "57373", "43226", "44228", "57374", "34780",
                 "34805",
                 "43651", "57375", "28482", "57376", "36690", "23641", "43661", "57377", "57378", "57379", "57380",
                 "57381",
                 "57382", "57383", "57413", "18802", "23735", "29202", "29171", "29187", "26110", "57414", "40476",
                 "50547",
                 "57415", "27171", "13204", "13550", "13531", "54000", "57421", "57422", "57423", "48893", "13593",
                 "45874",
                 "41709", "41528", "41689", "41699", "41695", "11412", "11485", "41444", "57263", "41461", "57356",
                 "57357",
                 "49882", "57358", "57359", "57360", "36354", "19996", "20007", "57361", "49822", "49929", "50103",
                 "19994",
                 "57362", "57363", "21503", "19975", "42254", "19986", "57364", "37957", "16941", "13878", "49770",
                 "19995",
                 "44372", "40484", "34318", "34306", "43072", "46427", "50314", "57388", "26408", "57389", "43531",
                 "29573",
                 "30332", "44428", "23296", "26781", "42738", "57390", "44373", "34177", "57395", "46087", "57396",
                 "57397",
                 "30789", "33318", "33334", "57398", "57399", "18423", "57400", "37508", "35899", "29109", "29239",
                 "57401",
                 "18423", "13520", "25656", "21715", "48035", "38802", "18163", "46510", "46546", "15726", "21644",
                 "19836",
                 "19311", "19788", "19893", "19811", "57365", "57366", "17513", "57367", "43613", "19804", "57368",
                 "57369",
                 "19866", "57370", "57371", "34551", "19840", "50337", "57443", "44373", "34177", "57395", "47261",
                 "57446",
                 "34190", "57447", "57448", "35025", "30148", "16242", "57444", "25744", "28499", "29906", "46066",
                 "43127",
                 "57440", "57441", "37242", "57442"]

area_list = ['beijing', 'shanghai', 'chongqing', 'shenzhen', 'chengdu', 'guangzhou', 'tianjin', 'suzhou', 'zhengzhou',
             'wuhan', 'hangzhou', 'shijiazhuang', 'nanjing', 'shenyang', 'jinan', 'changsha', 'xian', 'hefei',
             'qingdao',
             'dongguan', 'haerbin', 'dalian', 'changchun', 'zhongshan', 'foshan', 'nanning', 'wuxi', 'guiyang',
             'ningbo',
             'fuzhou', 'taiyuan', 'baoding', 'nanchang', 'xiamen', 'changzhou', 'zhuhai', 'yantai', 'kunming', 'haikou',
             'langfang', 'huizhou', 'tangshan', 'weifang', 'wulumuqi', 'huhehaote', 'yinchuan', 'xuzhou', 'luoyang',
             'lanzhou', 'xining']

position_length = len(position_list)
area_length = len(area_list)


class Handler(BaseHandler):
    retry_delay = {
        0: 1,
        1: 1,
        2: 1,
        3: 1,
        4: 1,
        5: 1,
        6: 1,
        7: 1,
        8: 1,
        9: 1,
        10: 1,
        11: 1,
        12: 2,
        13: 8,
        14: 16,
        15: 32,
        16: 64,
        17: 128,
        18: 256,
        19: 512,
        20: 1024
    }

    default_headers = {
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Encoding': 'gzip, deflate, sdch',
        'Accept-Language': 'zh-CN,zh;q=0.8',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
        'Referer': 'http://www.chinahr.com/',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36',
    }

    crawl_config = {
        'itag': 'v1',
        'retries': 3,
    }

    url = 'http://www.chinahr.com/{}/jobs/{}/'

    def on_start(self):
        self.crawl(self.url.format(area_list[0], position_list[0]),
                   save={'area': 0, 'position': 0, 'first': True},
                   callback=self.list_page,
                   force_update=True,
                   headers=self.default_headers,
                   )

    def list_page(self, response):
        if u'中华英才网' not in response.text:
            response.raise_for_status()
            return

        position = response.save['position']
        area = response.save['area']

        if response.save['first']:

            if position + 1 < position_length:
                self.crawl(self.url.format(area_list[area], position_list[position + 1]),
                           save={'area': area, 'position': position + 1, 'first': True},
                           callback=self.list_page,
                           headers=self.default_headers,
                           priority=1,

                           )
            else:
                if area + 1 < area_length:
                    self.crawl(self.url.format(area_list[area + 1], position_list[position]),
                               save={'area': area + 1, 'position': 0, 'first': True},
                               callback=self.list_page,
                               headers=self.default_headers,
                               priority=1,
                               )

            page = max([int(a.text()) for a in response.doc('.pageList a').items() if a.text().isdigit()])

            for i in range(1, page + 1):
                self.crawl(
                    response.url + str(i),
                    save={'area': area, 'position': position, 'first': False},
                    callback=self.list_page,
                    headers=self.default_headers,
                    priority=1,
                )

        for pos in response.doc('.resultList .e1 a').items():
            self.crawl(
                pos.attr.href,
                callback=self.get_content,
                headers=self.default_headers,
                priority=5,
            )

        for co in response.doc('.resultList .e3 a').items():
            self.crawl(
                co.attr.href,
                callback=self.get_content,
                headers=self.default_headers,
                priority=5,
            )

    def get_content(self, response):
        if u'中华英才网' not in response.text:
            response.raise_for_status()
        else:
            path = md5string(response.text)
            with open(RESULT_PATH + str(path), 'wb') as f:
                f.write(response.text.encode('utf-8'))
